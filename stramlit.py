# app.py
import streamlit as st
import pandas as pd
import joblib

st.set_page_config(page_title="ç»“ç›´è‚ ç™Œæœ¯åé«˜æ°´å¹³ç™Œç—‡å¤å‘ææƒ§é£é™©è®¡ç®—å™¨", layout="wide")

# å°è¯•åŠ è½½æ¨¡å‹
try:
    model = joblib.load("model.pkl")
except Exception as e:
    st.error(f"æ— æ³•åŠ è½½ model.pklï¼š{e}")
    st.stop()

st.markdown("<h1 style='text-align: center; color: #4CAF50;'>ç»“ç›´è‚ ç™Œæœ¯åé«˜æ°´å¹³ç™Œç—‡å¤å‘ææƒ§é£é™©è®¡ç®—å™¨</h1>", unsafe_allow_html=True)
st.markdown("---")

# --- è¾“å…¥è¡¨å• ---
col1, col2 = st.columns(2)

with col1:
    ç™Œç—‡åˆ†æœŸ = st.selectbox("ğŸ§¬ ç™Œç—‡åˆ†æœŸ", ["â… ", "â…¡", "â…¢", "â…£"])
    åˆå¹¶ç—‡ = st.radio("ğŸ©º åˆå¹¶ç—‡", ["æ— ", "æœ‰"])
    æ”¾åŒ–ç–—å² = st.radio("ğŸ”¬ æ”¾åŒ–ç–—å²", ["æœ‰", "æ— "])
    ç—…ç¨‹ = st.selectbox("ğŸ•’ ç—…ç¨‹ï¼ˆå¹´ï¼‰", ["â‰¤2å¹´", "ï¼2å¹´"])

with col2:
    æ€§åˆ« = st.radio("ğŸ‘« æ€§åˆ«", ["å¥³", "ç”·"])
    ç»æµæ°´å¹³ = st.selectbox("ğŸ’° ç»æµæ°´å¹³", ["2000 å…ƒä»¥ä¸‹", "2000-5000 å…ƒ", "5000 å…ƒä»¥ä¸Š"])
    åŒ»ä¿ç±»å‹_è‡ªè´¹ = st.radio("ğŸ“„ åŒ»ä¿ç±»å‹_è‡ªè´¹ï¼ˆè‡ªè´¹=æ˜¯ï¼‰", ["å¦", "æ˜¯"])
    ç–¾ç—…æ„ŸçŸ¥ = st.slider("ğŸ“‹ ç–¾ç—…æ„ŸçŸ¥è¯„åˆ† (0-80)", 0, 80, 40)

st.markdown("---")

# ç‚¹å‡»é¢„æµ‹
if st.button("ğŸ” é¢„æµ‹ç»“æœ"):
    # --- æŒ‰è§„åˆ™ç¼–ç  ---
    input_dict = {
        "ç™Œç—‡åˆ†æœŸ": {"â… ": 0, "â…¡": 0.333, "â…¢": 0.666, "â…£": 1}[ç™Œç—‡åˆ†æœŸ],
        "åˆå¹¶ç—‡": {"æ— ": 0, "æœ‰": 1}[åˆå¹¶ç—‡],
        "æ”¾åŒ–ç–—å²": {"æœ‰": 0, "æ— ": 1}[æ”¾åŒ–ç–—å²],  # æŒ‰ä½ ä¹‹å‰çš„ç¼–ç è§„åˆ™
        "ç—…ç¨‹": {"â‰¤2å¹´": 0, "ï¼2å¹´": 1}[ç—…ç¨‹],
        "æ€§åˆ«": {"å¥³": 0, "ç”·": 1}[æ€§åˆ«],
        "ç»æµæ°´å¹³": {"2000 å…ƒä»¥ä¸‹": 0, "2000-5000 å…ƒ": 0.5, "5000 å…ƒä»¥ä¸Š": 1}[ç»æµæ°´å¹³],
        "åŒ»ä¿ç±»å‹_è‡ªè´¹": 1 if åŒ»ä¿ç±»å‹_è‡ªè´¹ == "æ˜¯" else 0,
        "ç–¾ç—…æ„ŸçŸ¥": ç–¾ç—…æ„ŸçŸ¥,   # ä¿ç•™åŸå§‹åˆ†æ•°
    }

    # --- ä¿è¯åˆ—é¡ºåºä¸€è‡´ ---
    feature_order = ["ç™Œç—‡åˆ†æœŸ","åˆå¹¶ç—‡","æ”¾åŒ–ç–—å²","ç—…ç¨‹","æ€§åˆ«","ç»æµæ°´å¹³","åŒ»ä¿ç±»å‹_è‡ªè´¹","ç–¾ç—…æ„ŸçŸ¥"]
    X_input = pd.DataFrame([[input_dict[col] for col in feature_order]], columns=feature_order)

    # å±•ç¤ºè¾“å…¥
    with st.expander("æŸ¥çœ‹ä¼ ç»™æ¨¡å‹çš„ç‰¹å¾ï¼ˆç¼–ç åï¼‰"):
        st.write(X_input)

    # --- æ¨¡å‹é¢„æµ‹ ---
    try:
        prob = model.predict_proba(X_input)[0][1]
        st.markdown(
            f"""
            <div style="text-align: center; margin-top: 20px;">
                <h2 style="color: #e91e63;">é¢„æµ‹é£é™©æ¦‚ç‡ä¸ºï¼š</h2>
                <h1 style="color: #2196F3;">{prob * 100:.2f}%</h1>
            </div>
            """,
            unsafe_allow_html=True,
        )
    except Exception as e:
        st.error(f"æ¨¡å‹é¢„æµ‹å¤±è´¥ï¼š{e}")
